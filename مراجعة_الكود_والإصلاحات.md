# ูุฑุงุฌุนุฉ ุงูููุฏ ูุงูุฅุตูุงุญุงุช - ูุธุงู ุงูุญุถูุฑ ูุงูุบูุงุจ

## ูุธุฑุฉ ุนุงูุฉ

ุชูุช ูุฑุงุฌุนุฉ ููุฒุชูู ุชู ุชูููุฐููุง ูู ูุจู ุงููุทูุฑูู:
1. **ุชุนุฏูู ุงูููุทูุฉ ุงูุฒูููุฉ ุฅูู Asia/Damascus** ูู ุงุณุชุฌุงุจุงุช ุงููุนุงููุงุช
2. **ูููุฉ ูุฌุฏููุฉ ูุชุณุฌูู ุฎุฑูุฌ ุฌููุน ุงูุทูุงุจ** ูู ููุชุตู ุงูููู

---

## ุงูููุฒุฉ ุงูุฃููู: ุชุนุฏูู ุงูููุทูุฉ ุงูุฒูููุฉ

### โ ูุง ุชู ุชูููุฐู ุจุดูู ุตุญูุญ:

ุชู ุชุทุจูู ุชุญููู ุงูููุทูุฉ ุงูุฒูููุฉ ุจุดูู ุตุญูุญ ูู ุฌููุน ุฏูุงู ุงูุฎุฏูุฉ:
- `AttendanceService()` - ุงูุณุทุฑ 62
- `getTotalMonthlyAttendanceService()` - ุงูุณุทูุฑ 79-80, 87, 108, 120
- `Attendance_Records_By_UserId_Service()` - ุงูุณุทุฑ 143

### โ ุงููุดููุฉ ุงูุชู ุชู ุงูุชุดุงููุง:

ูู ููู `CardTransactionController.php` ุงูุณุทุฑ 56:
```php
// โ ูุจู ุงูุฅุตูุงุญ
'month' => Carbon::now()->format('F Y'),

// โ ุจุนุฏ ุงูุฅุตูุงุญ
'month' => Carbon::now('Asia/Damascus')->format('F Y'),
```

**ุงูุณุจุจ:** ุงุณุชุฎุฏุงู `Carbon::now()` ุจุฏูู ุชุญุฏูุฏ ุงูููุทูุฉ ุงูุฒูููุฉ ูุฌุนู Laravel ูุณุชุฎุฏู ุงูููุทูุฉ ุงูุฒูููุฉ ุงูุงูุชุฑุงุถูุฉ ููุณูุฑูุฑ (GMT)ุ ุจูููุง ูุฌุจ ุฃู ุชููู Asia/Damascus.

### ๐ ุงูุฏุฑุณ ุงููุณุชูุงุฏ:

ุนูุฏ ุงุณุชุฎุฏุงู Carbon ููุชุนุงูู ูุน ุงูุชูุงุฑูุฎ ูุงูุฃููุงุช ูู Laravel:
- **ุฏุงุฆูุงู ุญุฏุฏ ุงูููุทูุฉ ุงูุฒูููุฉ** ุนูุฏ ุงุณุชุฎุฏุงู `Carbon::now()` ุฃู `Carbon::parse()`
- ุงุณุชุฎุฏู `->timezone('Asia/Damascus')` ุจุนุฏ `parse()` ูุชุญููู ุงูููุช ุงููุฎุฒู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุงุณุชุฎุฏู `Carbon::now('Asia/Damascus')` ูุจุงุดุฑุฉ ุนูุฏ ุงูุญุงุฌุฉ ููููุช ุงูุญุงูู

**ูุซุงู ุตุญูุญ:**
```php
// ุชุญููู ููุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
$time = Carbon::parse($transaction->created_at)->timezone('Asia/Damascus');

// ุงูุญุตูู ุนูู ุงูููุช ุงูุญุงูู ุจููุทูุฉ ุฒูููุฉ ูุญุฏุฏุฉ
$now = Carbon::now('Asia/Damascus');
```

---

## ุงูููุฒุฉ ุงูุซุงููุฉ: ูููุฉ ุชุณุฌูู ุงูุฎุฑูุฌ ุงูุชููุงุฆู

### โ ุงููุดุงูู ุงูุญุฑุฌุฉ ุงูุชู ุชู ุงูุชุดุงููุง:

#### 1. ูุดููุฉ ุงูุฌุฏููุฉ ุงูุฒูููุฉ (Critical)

**ุงููุดููุฉ:**
```php
// โ ุงูููุฏ ุงูุฃุตูู ูู Kernel.php
$schedule->command('attendance:force-logout')
         ->everyMinute()  // โ ุฎุทุฃ! ุณูุนูู ูู ุฏูููุฉ ุจุฏูุงู ูู ููุชุตู ุงูููู
         ->withoutOverlapping();
```

**ุงูุฅุตูุงุญ:**
```php
// โ ุงูููุฏ ุงููุตุญุญ
$schedule->command('attendance:force-logout')
         ->dailyAt('00:00')           // โ ูุนูู ููููุงู ูู ููุชุตู ุงูููู
         ->timezone('Asia/Damascus')   // โ ุชุญุฏูุฏ ุงูููุทูุฉ ุงูุฒูููุฉ
         ->withoutOverlapping();
```

**ุงูุณุจุจ:** ุงุณุชุฎุฏุงู `everyMinute()` ูุฌุนู ุงููููุฉ ุชุนูู ูู ุฏูููุฉ ุจุฏูุงู ูู ูุฑุฉ ูุงุญุฏุฉ ููููุงู ูู ููุชุตู ุงูููู. ูุฐุง ุณูุคุฏู ุฅูู:
- ุงุณุชููุงู ููุงุฑุฏ ุบูุฑ ุถุฑูุฑู
- ุฅูุดุงุก ูุนุงููุงุช ุฎุฑูุฌ ูุชุนุฏุฏุฉ ุบูุฑ ูุฑุบูุจ ูููุง
- ุฅุฑูุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### 2. ูุดููุฉ ูู ุงุณุชุนูุงู SQL

**ุงููุดููุฉ:**
```php
// โ ุงูููุฏ ุงูุฃุตูู
$lastTransactionIds = CardTransaction::select(DB::raw('MAX(id)'))
    ->groupBy('card_id')
    ->pluck(DB::raw('MAX(id)'));  // โ ุฎุทุฃ ูู ุงุณุชุฎุฏุงู pluck
```

**ุงูุฅุตูุงุญ:**
```php
// โ ุงูููุฏ ุงููุตุญุญ
$lastTransactionIds = CardTransaction::select(DB::raw('MAX(id) as max_id'))
    ->groupBy('card_id')
    ->pluck('max_id');  // โ ุงุณุชุฎุฏุงู ุงุณู ุงูุนููุฏ ุงูุตุญูุญ
```

**ุงูุณุจุจ:** 
- `pluck()` ูุญุชุงุฌ ุงุณู ุนููุฏ ูุญุฏุฏุ ูููุณ `DB::raw()`
- ูุฌุจ ุฅุนุทุงุก ุงูู aggregate function ุงุณู ุจุงุณุชุฎุฏุงู `as`

#### 3. ูุดุงูู ุฅุถุงููุฉ ุชู ุฅุตูุงุญูุง:

- โ **ุงุณุชูุฑุงุฏ ุบูุฑ ูุณุชุฎุฏู:** `use Illuminate\Container\Attributes\Auth;`
- โ **ูุตู ุงูุฃูุฑ:** ูุงู "Command description" ุจุฏูุงู ูู ูุตู ูุงุถุญ
- โ **ุฅุถุงูุฉ ุฑุณุงูุฉ ุฅุนูุงููุฉ:** ูุฅุธูุงุฑ ุนุฏุฏ ุงูุทูุงุจ ุงูุฐูู ุชู ุชุณุฌูู ุฎุฑูุฌูู

---

## ุงููุดููุฉ ุงูุชูููุฉ: ุณุจุจ ุนุฏู ุนูู Schedule

### ุงููุดููุฉ ุงูุฑุฆูุณูุฉ:

ุนูุฏ ุชุดุบูู `php artisan schedule:list` ูุงูุช ุงููุชูุฌุฉ:
```
INFO  No scheduled tasks have been defined.
```

### ุงูุฃุณุจุงุจ ุงููุชุฑุงุจุทุฉ:

#### 1. ูููุน ููู Kernel.php ุฎุงุทุฆ

**ุงููุดููุฉ:**
- ุงูููู ูุงู ูู: `app/Console/Commands/Kernel.php` โ
- ุงููููุน ุงูุตุญูุญ: `app/Console/Kernel.php` โ

**ุงูุณุจุจ:** Laravel ูุจุญุซ ุนู `Kernel` ูู `app/Console/` ูุจุงุดุฑุฉุ ูููุณ ุฏุงุฎู ูุฌูุฏ `Commands`. ุนูุฏูุง ูููู ุงูููู ูู ุงูููุงู ุงูุฎุทุฃุ Laravel ูุง ูุณุชุทูุน ุงูุนุซูุฑ ุนููู ูุจุงูุชุงูู ูุง ูุชู ุชุญููู ุงูููุงู ุงููุฌุฏููุฉ.

#### 2. ุชุบููุฑุงุช Laravel 11 ูู Scheduling

**ุงููุดููุฉ ุงููุจุฑู:** 
ูู Laravel 11ุ ุชุบูุฑุช ุทุฑููุฉ ุชุนุฑูู ุงูููุงู ุงููุฌุฏููุฉ ุจุดูู ุฌุฐุฑู!

**ุงูุทุฑููุฉ ุงููุฏููุฉ (Laravel 10 ูุฃูู):**
```php
// app/Console/Kernel.php
protected function schedule(Schedule $schedule): void
{
    $schedule->command('attendance:force-logout')->daily();
}
```

**ุงูุทุฑููุฉ ุงูุฌุฏูุฏุฉ (Laravel 11):**
```php
// bootstrap/app.php
return Application::configure(basePath: dirname(__DIR__))
    ->withSchedule(function (Schedule $schedule): void {
        $schedule->command('attendance:force-logout')
                 ->dailyAt('00:00')
                 ->timezone('Asia/Damascus');
    })
    ->create();
```

**ุงูุณุจุจ:** Laravel 11 ุฃุนุงุฏ ููููุฉ ุงูุชุทุจูู ููููู ุฃูุซุฑ ุจุณุงุทุฉ. ุงูููุงู ุงููุฌุฏููุฉ ุงูุขู ุชูุนุฑูู ูุจุงุดุฑุฉ ูู `bootstrap/app.php` ุจุงุณุชุฎุฏุงู `withSchedule()`.

### ููุงุฐุง ูุดู Scheduleุ

1. **ุงูููู ูู ุงูููุงู ุงูุฎุทุฃ:** ุญุชู ูู ูุงู ุงูููุฏ ุตุญูุญุงูุ Laravel ูุง ูุฌุฏ `Kernel.php` ูู ุงูููุงู ุงููุชููุน
2. **Laravel 11 ูุชุทูุจ ุทุฑููุฉ ุฌุฏูุฏุฉ:** ุญุชู ุจุนุฏ ููู ุงูููู ููููุงู ุงูุตุญูุญุ Laravel 11 ููุถู ุงุณุชุฎุฏุงู `bootstrap/app.php` ูุชุนุฑูู ุงูููุงู ุงููุฌุฏููุฉ
3. **ุงููุชูุฌุฉ:** `schedule:list` ูุง ูุฌุฏ ุฃู ููุงู ูุฌุฏููุฉ ูุฃู Laravel ูุง ูุณุชุทูุน ุชุญููููุง

### ุงูุฅุตูุงุญ:

ุชู ุฅุตูุงุญ ุงููุดููุฉ ุจุทุฑููุชูู:

1. โ **ููู Kernel.php ูููููุน ุงูุตุญูุญ:** `app/Console/Kernel.php`
2. โ **ุฅุถุงูุฉ Schedule ูู bootstrap/app.php:** ุงุณุชุฎุฏุงู `withSchedule()` ููุชูุงูู ูุน Laravel 11

**ููุงุญุธุฉ ูููุฉ:** 
- ุชู ุฅุถุงูุฉ ุงูุฌุฏููุฉ ูู ููุง ุงูููุงููู (`Kernel.php` ู `bootstrap/app.php`) ูุถูุงู ุงูุชูุงูู
- Laravel 11 ููุฑุฃ ูู `bootstrap/app.php` ุฃููุงูุ ููู `Kernel.php` ูุง ูุฒุงู ูุนูู ููุณุฎุฉ ุงุญุชูุงุทูุฉ

### ๐ ุงูุฏุฑุณ ุงููุณุชูุงุฏ:

1. **ุนูุฏ ุงูุงูุชูุงู ูุฅุตุฏุงุฑ ุฌุฏูุฏ ูู Laravel:**
   - ุงูุฑุฃ ุฏููู ุงูุชุฑููุฉ (Upgrade Guide) ุฏุงุฆูุงู
   - ุงุฎุชุจุฑ ุงูุชุบููุฑุงุช ูู ุจูุฆุฉ ุชุทููุฑ ุฃููุงู
   - ุชุญูู ูู ุงูุชุบููุฑุงุช ูู ุงูุจููุฉ (Structure Changes)

2. **ุนูุฏ ุชุนุฑูู ุงูููุงู ุงููุฌุฏููุฉ:**
   - ูู Laravel 11ุ ุงุณุชุฎุฏู `bootstrap/app.php` ูุน `withSchedule()`
   - ุชุฃูุฏ ูู ุฃู ุงููููุงุช ูู ุงูุฃูุงูู ุงูุตุญูุญุฉ
   - ุงุฎุชุจุฑ ุฏุงุฆูุงู ุจู `php artisan schedule:list` ุจุนุฏ ุงูุชุนุฏูู

3. **ุนูุฏ ููุงุฌูุฉ ูุดููุฉ "No scheduled tasks":**
   - ุชุญูู ูู ูููุน `Kernel.php` (ูุฌุจ ุฃู ูููู ูู `app/Console/`)
   - ูู Laravel 11ุ ุฃุถู Schedule ูู `bootstrap/app.php`
   - ุงูุณุญ ุงูู cache: `php artisan config:clear`

---

## ููุฎุต ุงูุฅุตูุงุญุงุช

### ุงููููุงุช ุงููุนุฏูุฉ:

1. โ `app/Http/Controllers/CardTransactionController.php`
   - ุฅุตูุงุญ ุงูููุทูุฉ ุงูุฒูููุฉ ูู `getTotalMonthlyAttendance()`

2. โ `app/Console/Commands/ForceLogoutForgotten.php`
   - ุฅุตูุงุญ ุงุณุชุนูุงู SQL
   - ุฅุฒุงูุฉ ุงูุงุณุชูุฑุงุฏุงุช ุบูุฑ ุงููุณุชุฎุฏูุฉ
   - ุชุญุณูู ุงููุตู
   - ุฅุถุงูุฉ ุฑุณุงูุฉ ุฅุนูุงููุฉ

3. โ `app/Console/Commands/Kernel.php` โ `app/Console/Kernel.php`
   - ููู ุงูููู ูููููุน ุงูุตุญูุญ
   - ุฅุตูุงุญ ุงูุฌุฏููุฉ ุงูุฒูููุฉ

4. โ `bootstrap/app.php`
   - ุฅุถุงูุฉ `withSchedule()` ููุชูุงูู ูุน Laravel 11

---

## ุฏุฑูุณ ุชุนููููุฉ ูููุฉ

### 1. ุงุฎุชุจุงุฑ ุงูููุฏ ูุจู ุงูุฑูุน

**ูุจู:** ูู ูุชู ุงุฎุชุจุงุฑ ุงููููุฉ ุงููุฌุฏููุฉ ุจุดูู ุตุญูุญ
**ุจุนุฏ:** ูุฌุจ ุฏุงุฆูุงู:
```bash
php artisan schedule:list    # ููุชุญูู ูู ุงูููุงู ุงููุฌุฏููุฉ
php artisan attendance:force-logout  # ูุงุฎุชุจุงุฑ ุงูุฃูุฑ ูุฏููุงู
```

### 2. ููู Laravel Scheduling Methods

- `->everyMinute()` - ูู ุฏูููุฉ (ุงุณุชุฎุฏู ุจุญุฐุฑ!)
- `->daily()` - ูุฑุฉ ููููุงู ูู ููุชุตู ุงูููู
- `->dailyAt('00:00')` - ูุฑุฉ ููููุงู ูู ููุช ูุญุฏุฏ
- `->timezone('Asia/Damascus')` - ุชุญุฏูุฏ ุงูููุทูุฉ ุงูุฒูููุฉ
- `->withoutOverlapping()` - ููุน ุงูุชุฏุงุฎู

### 3. SQL Aggregation ูู Laravel

```php
// โ ุฎุทุฃ
->pluck(DB::raw('MAX(id)'))

// โ ุตุญูุญ
->select(DB::raw('MAX(id) as max_id'))
->pluck('max_id')
```

### 4. Laravel 11 Changes

- ุงูุฑุฃ ุฏููู ุงูุชุฑููุฉ ุนูุฏ ุงูุงูุชูุงู ูุฅุตุฏุงุฑ ุฌุฏูุฏ
- `bootstrap/app.php` ุฃุตุจุญ ุฃูุซุฑ ุฃูููุฉ ูู Laravel 11
- ุงุฎุชุจุฑ ุงูุชุบููุฑุงุช ูู ุจูุฆุฉ ุชุทููุฑ ุฃููุงู

---

## ูุตุงุฆุญ ูููุณุชูุจู

1. โ **ุงูุฑุฃ ุงููุซุงุฆู ุงูุฑุณููุฉ** ูุจู ุงุณุชุฎุฏุงู ููุฒุฉ ุฌุฏูุฏุฉ
2. โ **ุงุฎุชุจุฑ ุงูููุฏ ูุญููุงู** ูุจู ุงูุฑูุน ููุฅูุชุงุฌ
3. โ **ุงุณุชุฎุฏู `php artisan schedule:list`** ููุชุญูู ูู ุงูููุงู ุงููุฌุฏููุฉ
4. โ **ุฑุงูุจ ุงูุณุฌูุงุช** (`storage/logs/laravel.log`) ููุชุญูู ูู ุชูููุฐ ุงูููุงู
5. โ **ุฑุงุฌุน ุงูููุฏ ูุน ุฒููุงุฆู** ูุจู ุงูุฑูุน

---

## ุงูุฎูุงุตุฉ

ุชู ุฅุตูุงุญ ุฌููุน ุงููุดุงูู ุงูุญุฑุฌุฉ:
- โ ุงูููุทูุฉ ุงูุฒูููุฉ ุชุนูู ุจุดูู ุตุญูุญ
- โ ุงููููุฉ ุงููุฌุฏููุฉ ุชุนูู ููููุงู ูู ููุชุตู ุงูููู
- โ Laravel 11 Scheduling ูุนูู ุจุดูู ุตุญูุญ

ุงูููุฏ ุงูุขู ุฌุงูุฒ ููุฅูุชุงุฌ! ๐

---

**ุชุงุฑูุฎ ุงููุฑุงุฌุนุฉ:** 2025
**ุงููุฑุงุฌุน:** Team Leader
**ุงูุญุงูุฉ:** โ ุชู ุงูุฅุตูุงุญ ูุงูุงุฎุชุจุงุฑ

